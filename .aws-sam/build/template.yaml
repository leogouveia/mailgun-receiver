AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'mailgun-receiver

  '
Globals:
  Function:
    Runtime: nodejs12.x
    Timeout: 10
    Handler: app.lambdaHandler
Resources:
  MailgunStoreFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: MailgunStoreFunction
      Handler: app.lambdaHandler
      Events:
        StoreData:
          Type: Api
          Properties:
            Path: /
            Method: post
        GetData:
          Type: Api
          Properties:
            Path: /
            Method: get
  MailgunTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: Id
        AttributeType: S
      - AttributeName: Event
        AttributeType: S
      - AttributeName: RecipientDomain
        AttributeType: S
      - AttributeName: Recipient
        AttributeType: S
      - AttributeName: Message.Id
        AttributeType: S
      - AttributeName: Message.Headers.To
        AttributeType: S
      - AttributeName: Message.Headers.From
        AttributeType: S
      - AttributeName: Message.Headers.Subject
        AttributeType: S
      - AttributeName: Message.Size
        AttributeType: S
      - AttributeName: Timestamp
        AttributeType: N
      - AttributeName: Signature.Token
        AttributeType: S
      - AttributeName: Signature.Signature
        AttributeType: S
      - AttributeName: Signature.Timestamp
        AttributeType: S
      - AttributeName: Storage.url
        AttributeType: S
      - AttributeName: Storage.key
        AttributeType: S
      - AttributeName: Envelope.SendingIp
        AttributeType: S
      - AttributeName: Envelope.Sender
        AttributeType: S
      - AttributeName: Envelope.Transport
        AttributeType: S
      - AttributeName: Envelope.Targets
        AttributeType: S
      - AttributeName: DeliveryStatus.Tls
        AttributeType: S
      - AttributeName: DeliveryStatus.MxHost
        AttributeType: S
      - AttributeName: DeliveryStatus.AttemptNo
        AttributeType: N
      - AttributeName: DeliveryStatus.Description
        AttributeType: S
      - AttributeName: DeliveryStatus.SessionSeconds
        AttributeType: N
      - AttributeName: DeliveryStatus.Utf8
        AttributeType: S
      - AttributeName: DeliveryStatus.Code
        AttributeType: N
      - AttributeName: DeliveryStatus.Message
        AttributeType: S
      - AttributeName: DeliveryStatus.CertificateVerified
        AttributeType: S
      KeySchema:
      - AttributeName: Id
        KeyType: HASH
      - AttributeName: Message.Id
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: '5'
        WriteCapacityUnits: '5'
      TableName: mailGunTable
Outputs:
  MailgunStoreApi:
    Description: API Gateway endpoint URL for Prod stage for Mail Gun Store function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  MailgunStoreFunction:
    Description: Mailgun Store Lambda Function ARN
    Value:
      Fn::GetAtt:
      - MailGunStoreFunction
      - Arn
  MailgunStoreFunctionIamRole:
    Description: Implicit IAM Role created for Mailgun Store function
    Value:
      Fn::GetAtt:
      - MailgunStoreFunctionRole
      - Arn
